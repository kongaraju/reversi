function resetPawn(e,t){e=$(e);t=$(t);var n=e.offset();e.appendTo(t);var r=e.offset();var i=e.clone().appendTo("body");i.css("position","absolute").css("left",n.left).css("top",n.top).css("zIndex",1e3);e.hide();i.animate({top:r.top,left:r.left},"slow",function(){e.show();i.remove()})}function moveAnimate(e,t,n){if(n>=t.length){return}var r="#pos"+t[n],e=$(e);r=$(r);var i=e.offset();e.appendTo(r);var s=e.offset();var o=e.clone().appendTo("body");o.css("position","absolute").css("left",i.left).css("top",i.top).css("zIndex",1e3);e.hide();o.animate({top:s.top,left:s.left},"slow",function(){e.show();o.remove();n++;moveAnimate(e,t,n)})}function conOpen(e){}function conError(){}function conClose(){}function send(e){var t="astchma";var n=JSON.stringify(e);var r=new ArrayBuffer(n.length+4+12);var i=new DataView(r);i.setInt32(0,clientid);if(t.length<12){for(var s=0;s<12-t.length;s++){t+=" "}}for(var s=0;s<t.length;s++){i.setUint8(s+4,t.charCodeAt(s))}for(var s=0;s<n.length;s++){i.setUint8(s+16,n.charCodeAt(s))}ws.send(r);return}function recieveMessage(e){var recvBuffer=e.data;var dv=new DataView(recvBuffer);var clientid=dv.getInt32(0,false);var service=new String;for(var i=4;i<16;i++){service+=String.fromCharCode(dv.getUint8(i))}var jsonstr="";for(var i=16;i<e.data.byteLength;i++){jsonstr+=String.fromCharCode(dv.getUint8(i))}var obj=eval("("+jsonstr.toString()+")");service=service.toString().replace(/[\x00-\x1F\x80-\xFF]/g,"");obj.service=service.substring(0,service.indexOf(" "))||service;obj.clientid=clientid;return obj}function handleMessage(e){app.handleMessage(e)}function send_feedback(e){var t=$("#feedback").val();$("#feedback").empty();if(t){var n={id:app.get("id"),name:app.get("first_name"),email:app.get("email"),stmt:t};$.ajax({url:"../php/feedback.php",type:"post",data:{userFeedback:JSON.stringify(n)},success:function(e,t,n){console.log("feedback recorded successfully "+e.message)},error:function(e,t,n){console.log("The following error occured while recording feedback : "+t,n)},complete:function(){}})}}function send_message_FB(){FB.ui({method:"send",name:"play asta chamma online",link:"http://www.astachamma.com/",description:"Hi friends lets play our traditional game asta chamma online. Do you want to play with me, login to astachamma.com"})}function get_friends(){FB.api("/me/friends",function(e){var t=[];var n=e.data;for(var r=0;r<n.length;r++){t.push(n[r].id)}shareWithFacebook(t)})}function shareWithFacebook(e){FB.ui({method:"apprequests",message:"Hi friends lets play our traditional game asta chamma online"},requestCallback)}function requestCallback(e){}function facebookLogin(){FB.login(function(e){if(e.authResponse){}else{console.log("User cancelled login or did not fully authorize.")}},{scope:"email,user_birthday,user_work_history,friends_online_presence"})}function getInfo(e){var t=e.location;var n=e.work;var r={id:e.id,dob:e.birthday,dept:"",middle_name:"",mob:"",organization:"",jobtitle:"",homeaddress:"",email:e.email,first_name:e.first_name,last_name:e.last_name,sex:e.gender,name:e.first_name+" "+e.last_name};if(t){r.homeaddress=t.name}if(n){if(n[0].employer)r.organization=n[0].employer.name;if(n[0].position)r.jobtitle=n[0].position.name}return r}function userfbCheck(){FB.api("/me",function(e){var t=getInfo(e);app.setInfo(t);$.ajax({url:"php/fblogin.php",type:"post",data:{userProfile:JSON.stringify(t)},success:function(e,n,r){var i=JSON.parse(e);app.login(t)},error:function(e,t,n){console.log("The following error occured: "+t,n)},complete:function(){console.log("user authentication successful.")}})})}var roll=function(){this.timer=null;this.temp=null};roll.prototype.start=function(){clearInterval(this.timer);this.timer=setInterval(this.changecount,1)};roll.prototype.changecount=function(){var e=[1,2,3,4,8];var t=e[Math.floor(Math.random()*e.length)];$("#count-card").html(t)};roll.prototype.dispCount=function(e){$("#count-card").html(e)};roll.prototype.stop=function(e){var t=this;clearTimeout(this.temp);this.temp=setTimeout(function(){t.hang(e,t)},3e3)};roll.prototype.hang=function(e,t){var n=t;clearInterval(n.timer);clearTimeout(n.temp);this.dispCount(e);log.alert("huh!"+e+" rolled..")};var animation=new roll;var helpView=function(){this.el=$("#log");this.defaults={align:"bottomRight",timeout:1e4,closeOnClick:false}};helpView.prototype.alert=function(e){var t=$("<p/>").addClass("log-msg").appendTo(this.el);if(typeof e==="object"){t.append(e.text)}else if(typeof e==="string"){t.append(e);setTimeout(function(){t.remove()},1e4)}else{}return t};helpView.prototype.success=function(){};helpView.prototype.error=function(){};helpView.prototype.warning=function(){};var log=new helpView;var boards=function(){this.boards={};this.count=0};boards.prototype.add=function(e){var t=this.boards[e.boardid]={id:e.boardid,name:e.boardname,player1:e.player1,player2:e.player2,player3:e.player3,player4:e.player4};app.addNewBoard(t);if(this.count==e.boardid)app.hideLoadingMsg()};boards.prototype.addPlayer=function(e,t,n){var r=this.boards[e];r["player"+n]=t;app.incPlayer(t,e,"player"+n)};boards.prototype.remove=function(e){app.removeBoard(e)};boards.prototype.get=function(e){return this.boards[e]};var game=function(){this.id=null;this.playerCount=0;this.table=null;this.map={};this.self=null;this.diedCount=0;this.homeCount=0;this.canUpdate=true;this.hasPass=false;this.timer=null;this.updater=null;this.players={player1:{pawns:"#p11,#p12,#p13,#p14",1:{el:"#p11",status:false},2:{el:"#p12",status:false},3:{el:"#p13",status:false},4:{el:"#p14",status:false}},player2:{pawns:"#p21,#p22,#p23,#p24",1:{el:"#p21",status:false},2:{el:"#p22",status:false},3:{el:"#p23",status:false},4:{el:"#p24",status:false}},player3:{pawns:"#p31,#p32,#p33,#p34",1:{el:"#p31",status:false},2:{el:"#p32",status:false},3:{el:"#p33",status:false},4:{el:"#p34",status:false}},player4:{pawns:"#p41,#p42,#p43,#p44",1:{el:"#p41",status:false},2:{el:"#p42",status:false},3:{el:"#p43",status:false},4:{el:"#p44",status:false}}}};game.prototype.diedStatus=function(){var e=this.players[app.get("playerid")];var t=false;for(var n=1;n<=4;n++){if(!e[n].status)t=true}return t};game.prototype.init=function(e){this.board=e;$("#start").hide();$(".roll_btn").attr("disabled","disabled");$(".coin").unbind("click");$("#leave").show().bind("click",this.board.id,this.leave);$(".start_wait").show();for(var t=1;t<=4;t++)if(e["player"+t])this.addPlayer(e["player"+t],"player"+t)};game.prototype.addPlayer=function(e,t){this.board[t]=e;this.playerCount++;this.showStart();this.alivePawns(t);this.players[t]["id"]=e;this.players[t]["status"]=true;$("#"+t+"_pic").attr("src","https://graph.facebook.com/"+e+"/picture");$("."+t+"_set").show()};game.prototype.removePlayer=function(e){var t=".player"+e.playerid+"_set";$(t).hide();for(var n=1;n<5;n++){var r="#p"+e.playerid+""+n;$(r).hide()}log.alert("player leaved the board")};game.prototype.alivePawns=function(e){for(var t=1;t<=4;t++){this.players[e][t].status=true}};game.prototype.start=function(e){app.startGame(e.data)};game.prototype.showStart=function(){if(this.playerCount>1){$(".start_wait").hide();$("#start").show().bind("click",this.board.id,this.start)}};game.prototype.leave=function(e){app.leavePlayer(e.data)};game.prototype.play=function(){$("#start").hide();$("#leave").show().bind("click",this.board.id,this.leave)};game.prototype.stop=function(){};game.prototype.update=function(e){if(this.canUpdate){var t=this.getMoves(e.map);for(pawn in t){moveAnimate("#p"+t[pawn].pawnid,[t[pawn].cellid],0)}}this.canUpdate=true};game.prototype.getMoves=function(e){var t=[];if(this.table==null){this.table=e;t=e;for(p in e){this.map[e[p].pawnid]=e[p].cellid}}else{for(p in e){if(this.map[e[p].pawnid]!=e[p].cellid){this.map[e[p].pawnid]=e[p].cellid;t.push(e[p])}}this.table=e}return t};game.prototype.enableTurn=function(e){var t=this;$("#player"+e.playerid+"_pic").addClass("blink2").css({"-webkit-animation-play-state":"running","-moz-animation-play-state":"running","-o-animation-play-state":"running","animation-play-state":"running"});$(".roll_btn").removeAttr("disabled").click(function(){app.rollReq();$(this).attr("disabled","disabled").unbind("click")})};game.prototype.animateCoin=function(e,t){this.canUpdate=false;moveAnimate("#p"+e,t,0)};game.prototype.enablePawnSelect=function(e){$(".coin").unbind("click");var t=e;t.afterAnim(t)};game.prototype.afterAnim=function(e){var t=e;var n=app.get("playerid");var r=t.players["player"+n].pawns;$(r).bind("click",{coins:r,count:t.roll_count,obj:t},t.selectCoin)};game.prototype.selectCoin=function(e){var t=this.id;var n=e.data.obj;var r=t.substr(1,2);var i=$(this).parent("td").attr("id");if(!i){if(e.data.obj.roll_count==4){app.bringPawn(r);n.disablePawnSelect(e.data.coins)}else if(e.data.count==8){app.bringPawn(r);e.data.obj.roll_count=4}else{log.alert("Move not possible!<br/> Please select another coin to move.")}}else{var s=i.substr(3,2);app.moveReq(r,s,e.data.obj.roll_count);n.disablePawnSelect(e.data.coins)}};game.prototype.disablePawnSelect=function(e){$(e).unbind("click");clearTimeout(this.timer);clearInterval(this.updater);$(".countDown").hide()};game.prototype.rollStart=function(){animation.start()};game.prototype.startCountDown=function(){var e=this;var t=this.players["player"+this.self].pawns;setTimeout(function(){$(".countDown").show();$("#timer").html("30");clearTimeout(e.timer);e.timer=setTimeout(function(){e.disablePawnSelect(t);app.moveReq(0,0,0)},3e4);var n=30;clearInterval(e.updater);e.updater=setInterval(function(){$("#timer").addClass("text-error").html(" "+n--)},1e3)},3e3)};game.prototype.rollStop=function(e){animation.stop(e.roll_count);this.roll_count=e.roll_count;var t=this.self;if(e.playerid==this.self&&e.roll_count>3)this.hasPass=true;if(this.diedCount+this.homeCount==4&&e.roll_count<4){setTimeout(function(){if(e.playerid==t)app.moveReq(0,0,0);log.alert("move not possible.")},3e3)}else if(!this.hasPass){setTimeout(function(){if(e.playerid==t)app.moveReq(0,0,0)},3e3)}else{if(e.playerid==t)this.startCountDown();if(this.diedCount>0&&this.roll_count>3)log.alert("You can get pawn or move pawn");else var n=this;setTimeout(function(){n.enablePawnSelect(n)},3e3)}};game.prototype.movePawn=function(){};game.prototype.addPawn=function(e){var t=String(e.pawnid);var n=e.playerid;this.players["player"+n][t.substr(1,2)].status=true;if(e.playerid==this.self)this.diedCount--};game.prototype.removePawn=function(e){var t=String(e.pawnid);var n=e.playerid;this.players["player"+n][t.substr(1,2)].status=false;resetPawn("#p"+t,"#player"+n);if(e.playerid==this.self)this.diedCount++};game.prototype.gotHome=function(e){if(e.playerid==this.self)this.homeCount++};game.prototype.moveIgnore=function(){};var Application=function(){this.me=null;this._me={joined:false,boardCreator:true,boardName:null};this.map={};this.init=function(){var e=this;$("#pagain").bind("click",function(){$(".gameEnd, .lost, .won").hide();$(".available-boards").show();e.resetBoard();e.setBoards()})};this.init()};Application.prototype.showAnimation=function(){$(".logboard").hide();$(".auth-system").append("<p class=text-info>please wait Loading..</p>")};Application.prototype.setBoards=function(){$(".content section").hide();$(".available-boards").show();var e=this;$(".newBoard").removeAttr("disabled").bind("click",function(){$(this).attr("disabled",true);e.createBoard()})};Application.prototype.resetBoard=function(){this.set("joined",false);this.set("boardCreator",false);this.set("boardName",null);this.set("playerid",null);this.set("boardid",null);this.sgame=null;$("#p11,#p12,#p13,#p14").appendTo("#player1_set");$("#p21,#p22,#p23,#p24").appendTo("#player2_set");$("#p31,#p32,#p33,#p34").appendTo("#player3_set");$("#p41,#p42,#p43,#p44").appendTo("#player4_set");$("#player1_set,#player2_set,#player3_set,#player4_set,#start,#leave").hide();$("#player1_pic,#player2_pic,#player3_pic,#player4_pic").removeAttr("src")};Application.prototype.showBoards=function(e){$(".auth-system, .help").hide();var t=e.data;$(".newBoard").removeAttr("disabled").bind("click",function(){$(this).attr("disabled",true);t.createBoard()});$(".available-boards, .content, .app").show()};Application.prototype.showHelp=function(){$(".auth-system").hide();$(".help, .content, .app").show();$(".navBoards").show();$("#feedback_btn").show();$("#goBoards").bind("click",this,this.showBoards)};Application.prototype.addNewBoard=function(e){var t=this;var n=$("<div/>").addClass("brdPlayers");for(var r=1;r<=4;r++){var i="player"+r;if(!e[i])continue;$("<img/>").attr("src","https://graph.facebook.com/"+e[i]+"/picture").addClass("img-rounded").appendTo(n)}var s;if(e.started=="false"){s=$("<button/>").append("join").addClass("btn btn-success pull-right joinbtn").bind("click",function(){t.joinPlayer(e.id)})}var o=$("<div/>").addClass("brdname well").append("<p class=pull-left>"+e.name+"</p>").append(s);$("<div/>").addClass("boardPanel thumbnail").append(o).append(n).attr("data-bid",e.id).prependTo(".boards-list");if($(".available-boards .emptymsg").length)$(".available-boards .emptymsg").remove()};Application.prototype.createBoard=function(){var e=this;var t=$("<img/>").attr("src","https://graph.facebook.com/"+this._me["id"]+"/picture").addClass("img-rounded");var n=$("<div/>").addClass("brdPlayers").append(t);var r=$("<input/>").attr({type:"text",placeholder:"Enter board name.."}).bind("keypress",function(t){if(t.keyCode==13){var n=$(this).val();$(this).attr("disabled",true);e.openBoard(n)}});var i=$("<div/>").addClass("brdname well well-small").append(r);$("<div/>").addClass("boardPanel thumbnail tempboard").append(i).append(n).prependTo(".boards-list");if($(".available-boards .emptymsg").length)$(".available-boards .emptymsg").remove()};Application.prototype.incPlayer=function(e,t,n){var r=$("<img/>").attr("src","https://graph.facebook.com/"+e+"/picture").addClass("img-rounded");var i=$(".boardPanel[data-bid="+t+"]");if(i.length)i.children(".brdPlayers").append(r);if(this.get("joined"))if(this.get("boardid")==t)this.addGamePlayer(e,n)};Application.prototype.removeBoard=function(e){$(".boardPanel[data-bid="+e+"]").children(".joinbtn").remove();if(this.get("joined"))if(this.get("boardid")==e)this.sgame.play()};Application.prototype.addGamePlayer=function(e,t){this.sgame.addPlayer(e,t)};Application.prototype.showEmptyPanel=function(){$(".available-boards").append("<p class='emptymsg alert alert-info'>There are no available boards, create a board to play</p>")};Application.prototype.showLoadingBoards=function(){};Application.prototype.hideLoadingMsg=function(){$(".loadingboards").remove()};Application.prototype.removeTemp=function(){$(".tempboard").remove()};Application.prototype.showboard=function(){$(".available-boards").slideUp();$(".game").slideDown()};Application.prototype.throwErr=function(e){if(e==1){this.hide();this.showExisted()}};Application.prototype.gameOver=function(e){$("#game").hide();if(e.winner==this.sgame.self)$(".gameEnd, .gameEnd .won").show();else $(".gameEnd, .gameEnd .won").show()};Application.prototype.showExisted=function(){alert("player already loggedin on other mechine.")};Application.prototype.hide=function(){$(".logboard,.auth-system,.available-boards, .content, .app,.game").hide()};Application.prototype.showUser=function(e,t){$("#me-pic").attr("src","https://graph.facebook.com/"+e+"/picture?width=32&height=32").addClass("img-rounded");$("#me-name").append(t)};Application.prototype.initGame=function(){this.showboard();this.set("joined",true);var e=boardlist.get(this.get("boardid"));this.sgame=new game;this.sgame.init(e)};Application.prototype.createUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e=="x"?t:t&3|8;return n.toString(16)})};Application.prototype.startGame=function(e){var t={mesgtype:"request",request:"start",cookie:this.createUUID(),boardid:e};send(t);this.map[t.cookie]="start"};Application.prototype.rollReq=function(e){var t={mesgtype:"request",request:"roll",cookie:this.createUUID(),boardid:this.get("boardid"),playerid:this.get("playerid")};send(t);this.map[t.cookie]="roll"};Application.prototype.moveReq=function(e,t,n){var r={mesgtype:"request",request:"move",cookie:this.createUUID(),boardid:this.get("boardid"),playerid:this.get("playerid"),pawnid:e,from:t,roll_count:n};send(r);this.map[r.cookie]="move";$(".pyr_pic").removeClass("blink2").css({"-webkit-animation-play-state":"paused","-moz-animation-play-state":"paused","-o-animation-play-state":"paused","animation-play-state":"paused"})};Application.prototype.bringPawn=function(e){var t={mesgtype:"request",request:"bring_pawn",cookie:this.createUUID(),pawnid:e,playerid:this.get("playerid"),boardid:this.get("boardid")};send(t);this.map[t.cookie]="getpawn"};Application.prototype.login=function(e){var t={mesgtype:"request",request:"login",cookie:this.createUUID(),loginid:e.id,name:e.first_name};send(t);this.map[t.cookie]="login";this.showUser(e.id,e.first_name)};Application.prototype.getBoards=function(){var e={mesgtype:"request",request:"get_board_list",cookie:this.createUUID()};send(e);this.map[e.cookie]="boards"};Application.prototype.openBoard=function(e){var t={mesgtype:"request",request:"open_board",cookie:this.createUUID(),loginid:this._me["id"],name:e};send(t);this.map[t.cookie]="openBoard";this._me["boardName"]=e};Application.prototype.joinPlayer=function(e){var t={mesgtype:"request",request:"join",cookie:this.createUUID(),loginid:this.get("id"),boardid:e};send(t);this.map[t.cookie]="join";this.set("boardid",e);this.initGame()};Application.prototype.leavePlayer=function(e){var t={mesgtype:"request",request:"leave",cookie:this.createUUID(),loginid:this.get("id"),boardid:e};send(t);this.map[t.cookie]="leave"};Application.prototype.handleMessage=function(e){var t=recieveMessage(e);if(!clientidRecvd){clientid=t.clientid;clientidRecvd=true}else if(t.mesgtype=="event"){switch(t.eventtype){case"new_board":boardlist.add(t);if(this.get("boardCreator"))if(t.boardname==this.get("boardName")){this.joinPlayer(t.boardid);this.set("joined",true);this.removeTemp()}break;case"player_join":boardlist.addPlayer(t.boardid,t.loginid,t.playerid);break;case"player_leave":this.sgame.removePlayer(t);break;case"board_started":boardlist.remove(t.boardid);log.alert("Lets play the game.");break;case"board_update":this.sgame.update(t);break;case"board_animate":this.sgame.animateCoin(t.pawnid,t.move_list);break;case"board_deleted":boardlist.remove(t.boardid);break;case"turn_event":log.alert(":) Its your Turn, Lets roll!.");this.sgame.enableTurn(t);break;case"roll_start":this.sgame.rollStart();break;case"roll_stop":this.sgame.rollStop(t);break;case"move_not_possible":log.alert("You cannot move the coin");this.sgame.moveIgnore();break;case"pawn_died":log.alert("oh! coin died");this.sgame.removePawn(t);break;case"pawn_alive":log.alert("pawn released");this.sgame.addPawn(t);break;case"home_event":this.sgame.gotHome(t);break;case"chance_event":log.alert(":) You got one more chance!");this.sgame.enablePawnSelect(this.sgame);break;case"game_over_event":app.gameOver(t);break;case"service_down":$("body").hide();alert("server down, please try after some time");break;default:}}else{switch(this.map[t.cookie]){case"login":if(t.mesgtype=="error"){app.throwErr(1)}else{this.showHelp();this.getBoards()}break;case"boards":if(t.board_count==0)this.showEmptyPanel();else if(t.board_count){boardlist.count=t.board_count;this.showLoadingBoards()}else{boardlist.add(t)}break;case"openBoard":if(t.status=="success")this._me["boardCreator"]=true;break;case"join":this.set("playerid",t.playerid);this.sgame.self=t.playerid;break;case"start":break;case"roll":break;case"getpawn":break;case"leave":this.resetBoard();this.setBoards();break;default:}}};Application.prototype.logout=function(){var e={mesgtype:"request",request:"logout",cookie:this.createUUID(),loginid:this.get("id")};send(e);this.map[e.cookie]="logout"};Application.prototype.setInfo=function(e){this._me=e};Application.prototype.get=function(e){if(e)return this._me[e];else return this._me};Application.prototype.set=function(e,t){this._me[e]=t;return};var list=function(){this.users={}};list.prototype.add=function(e){this.users[e.id]=e};list.prototype.get=function(e){return this.users[e]};var app=new Application;var boardlist=new boards;var userslist=new list;var ws=new WebSocket("ws://www.antkorp.in:443");var clientid=null;var clientidRecvd=false;ws.binaryType="arraybuffer";ws.onopen=conOpen;ws.onerror=conError;ws.onclose=conClose;ws.onmessage=handleMessage;(function(){var e=document.createElement("script");e.type="text/javascript";e.async=true;e.src="https://apis.google.com/js/plusone.js";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();$("#post_fk").bind("click",send_feedback);var fbusername;var fbbtn=$("<button/>").append("<i class='facebook_24'></i><span> Join with facebook</span>").addClass("facebook").bind("click",facebookLogin);var note_sec=$("<p/>").append("we do not send emails or store your details.").addClass("text-error");var fr=$("<div/>").addClass("logboard").append(fbbtn).append(note_sec).appendTo(".auth-system").hide();$("body").append('<div id="fb-root"></div>');$("#shareApp").bind("click",shareWithFacebook);window.fbAsyncInit=function(){FB.init({appId:0xfdce573fccc7,cookie:true,xfbml:true,oauth:true});FB.getLoginStatus(function(e){if(e.status==="connected"){var t=e.authResponse.userID;var n=e.authResponse.accessToken;userfbCheck()}else if(e.status==="not_authorized"){$(".logboard").fadeIn("fast")}else{$(".logboard").fadeIn("fast")}});FB.Event.subscribe("auth.login",function(e){userfbCheck()});FB.Event.subscribe("auth.logout",function(e){$("#logboard, #logOverlay").fadeIn("fast")})};(function(e){var t,n="facebook-jssdk";if(e.getElementById(n)){return}t=e.createElement("script");t.id=n;t.async=true;t.src="http://connect.facebook.net/en_US/all.js";e.getElementsByTagName("head")[0].appendChild(t)})(document)